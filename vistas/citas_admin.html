<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Clínica Dental</title>
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body>
    <div class="sidebar">
        <h3 class="text-center mb-4">DentalCare Admin</h3>
        <ul class="nav flex-column">
            <li class="nav-item">
                <a class="nav-link" href="dashboard.php"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            </li>
            <li class="nav-item">
                <a class="nav-link active" href="citas_admin.html"><i class="fas fa-calendar-alt"></i> Citas</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#"><i class="fas fa-user-md"></i> Doctores</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="registro_pacientes.html"><i class="fas fa-users"></i> Pacientes</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#"><i class="fas fa-clipboard-list"></i> Tratamientos</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="#"><i class="fas fa-cog"></i> Configuración</a>
            </li>
        </ul>
    </div>

    <div class="main-content">
        <div class="container-fluid">
            <div class="row">
                <main class="col-md-8">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">Calendario de Citas</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <div class="btn-group me-2">
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="viewWeek">Semana</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="viewMonth">Mes</button>
                            </div>
                            <button type="button" class="btn btn-sm btn-primary">
                                <i class="fas fa-plus"></i> Nueva Cita
                            </button>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <select class="form-select" id="selectLocal">
                                <option selected>Seleccionar Local</option>
                                <option value="1">Local 1</option>
                                <option value="2">Local 2</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="selectProfesional">
                                <option selected>Seleccionar Profesional</option>
                                <option value="1">Dr. García</option>
                                <option value="2">Dra. Martínez</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="selectEstado">
                                <option selected>Estado de Reserva</option>
                                <option value="1">Activas</option>
                                <option value="2">Canceladas</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Buscar cita...">
                                <button class="btn btn-outline-secondary" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Lunes</th>
                                    <th>Martes</th>
                                    <th>Miércoles</th>
                                    <th>Jueves</th>
                                    <th>Viernes</th>
                                    <th>Sábado</th>
                                    <th>Domingo</th>
                                </tr>
                            </thead>
                            <tbody id="calendarBody">
                                <!-- Las filas del calendario se generarán dinámicamente con JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </main>
                <aside class="col-md-4">
                    <div class="calendar-container mt-4">
                        <div id="calendar"></div>
                    </div>
                    <div class="dashboard-citas mt-4">
                        <h3>Dashboard de Citas</h3>
                        <div class="card">
                            <div class="card-body">
                                <h5 class="card-title">Resumen de Citas</h5>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Citas Hoy
                                        <span class="badge bg-primary rounded-pill" id="citasHoy">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Citas Pendientes
                                        <span class="badge bg-warning rounded-pill" id="citasPendientes">0</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Citas Completadas
                                        <span class="badge bg-success rounded-pill" id="citasCompletadas">0</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <div class="card mt-3">
                            <div class="card-body">
                                <h5 class="card-title">Próximas Citas</h5>
                                <ul class="list-group list-group-flush" id="proximasCitas">
                                    <!-- Las próximas citas se cargarán dinámicamente aquí -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </aside>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarBody = document.getElementById('calendarBody');
            const hours = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00', '19:00'];
            const viewWeekButton = document.getElementById('viewWeek');
            const viewMonthButton = document.getElementById('viewMonth');
            let currentView = 'week';

            function renderCalendar(view) {
                calendarBody.innerHTML = '';
                const today = new Date();
                const startOfWeek = new Date(today.setDate(today.getDate() - today.getDay() + 1)); // Monday as the start of the week

                if (view === 'week') {
                    hours.forEach(hour => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${hour}</td>`;
                        for (let i = 0; i < 7; i++) {
                            const cellDate = new Date(startOfWeek);
                            cellDate.setDate(startOfWeek.getDate() + i);
                            row.innerHTML += `<td data-date="${cellDate.toISOString().split('T')[0]}" data-hour="${hour}"></td>`;
                        }
                        calendarBody.appendChild(row);
                    });
                } else if (view === 'month') {
                    // Render month view (simplified example)
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    const daysInMonth = endOfMonth.getDate();
                    let currentDay = startOfMonth;

                    while (currentDay <= endOfMonth) {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${hours[currentDay.getHours()]}</td>`;
                        for (let i = 0; i < 7; i++) {
                            if (currentDay.getDate() <= daysInMonth) {
                                row.innerHTML += `<td data-date="${currentDay.toISOString().split('T')[0]}" data-hour="${hours[currentDay.getHours()]}"></td>`;
                                currentDay.setDate(currentDay.getDate() + 1);
                            } else {
                                row.innerHTML += '<td></td>';
                            }
                        }
                        calendarBody.appendChild(row);
                    }
                }
            }

            function fetchAppointments() {
                fetch('../modelos/recibir_citas.php')
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(appointment => {
                            const date = new Date(appointment.fecha_cita);
                            const dateString = date.toISOString().split('T')[0];
                            const hourString = date.getHours().toString().padStart(2, '0') + ':00';

                            const cell = calendarBody.querySelector(`td[data-date="${dateString}"][data-hour="${hourString}"]`);
                            if (cell) {
                                const appointmentEl = document.createElement('div');
                                appointmentEl.className = 'appointment';
                                appointmentEl.textContent = `${appointment.nombre_servicio} - ${appointment.nombre_usuario} a las ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                                cell.appendChild(appointmentEl);
                            }
                        });

                        actualizarDashboard(data);
                    })
                    .catch(error => console.error('Error al cargar las citas:', error));
            }

            function actualizarDashboard(citas) {
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);

                const citasHoy = citas.filter(cita => new Date(cita.fecha_cita).toDateString() === hoy.toDateString()).length;
                const citasPendientes = citas.filter(cita => new Date(cita.fecha_cita) > hoy).length;
                const citasCompletadas = citas.filter(cita => new Date(cita.fecha_cita) < hoy).length;

                document.getElementById('citasHoy').textContent = citasHoy;
                document.getElementById('citasPendientes').textContent = citasPendientes;
                document.getElementById('citasCompletadas').textContent = citasCompletadas;

                const proximasCitas = citas.filter(cita => new Date(cita.fecha_cita) >= hoy)
                    .sort((a, b) => new Date(a.fecha_cita) - new Date(b.fecha_cita))
                    .slice(0, 5);

                const proximasCitasEl = document.getElementById('proximasCitas');
                proximasCitasEl.innerHTML = '';
                proximasCitas.forEach(cita => {
                    const fechaCita = new Date(cita.fecha_cita);
                    const horas = fechaCita.getHours().toString().padStart(2, '0');
                    const minutos = fechaCita.getMinutes().toString().padStart(2, '0');
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = `${fechaCita.toLocaleDateString()} - ${cita.nombre_servicio} - ${cita.nombre_usuario} a las ${horas}:${minutos}`;
                    proximasCitasEl.appendChild(li);
                });
            }

            viewWeekButton.addEventListener('click', () => {
                currentView = 'week';
                renderCalendar(currentView);
                fetchAppointments();
            });

            viewMonthButton.addEventListener('click', () => {
                currentView = 'month';
                renderCalendar(currentView);
                fetchAppointments();
            });

            renderCalendar(currentView);
            fetchAppointments();

            flatpickr("#calendar", {
                inline: true,
                mode: "multiple",
                dateFormat: "Y-m-d"
            });
        });
    </script>
</body>
</html>
